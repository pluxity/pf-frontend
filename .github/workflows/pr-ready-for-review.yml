name: Move Issues to In Review on PR Ready

on:
  pull_request:
    types: [ready_for_review]

jobs:
  move-to-in-review:
    runs-on: ubuntu-latest

    steps:
      - name: Move linked issues to In Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Find linked issue numbers (closes #123, fixes #456, etc.)
            const pattern = /#(\d+)/g;
            const issueNumbers = new Set();

            let match;
            while ((match = pattern.exec(prBody)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }
            while ((match = pattern.exec(prTitle)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }

            if (issueNumbers.size === 0) {
              console.log('No linked issues found');
              return;
            }

            console.log(`Found linked issues: ${[...issueNumbers].join(', ')}`);

            // Project configuration
            const projectNumber = 17;
            const orgName = 'pluxity';
            const statusFieldId = 'PVTSSF_lADOC1m_S84BJx9Kzg5177k';
            const inReviewOptionId = '82d59cf2';

            for (const issueNumber of issueNumbers) {
              try {
                // Get issue node ID
                const issueResult = await github.graphql(`
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        id
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              number
                            }
                          }
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: issueNumber
                });

                const issue = issueResult.repository.issue;
                if (!issue) {
                  console.log(`Issue #${issueNumber} not found`);
                  continue;
                }

                // Find the project item for our project
                const projectItem = issue.projectItems.nodes.find(
                  item => item.project.number === projectNumber
                );

                if (!projectItem) {
                  console.log(`Issue #${issueNumber} is not in project ${projectNumber}`);
                  continue;
                }

                // Update the status to "In Review"
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `, {
                  projectId: 'PVT_kwDOC1m_S84BJx9K',
                  itemId: projectItem.id,
                  fieldId: statusFieldId,
                  optionId: inReviewOptionId
                });

                console.log(`Moved issue #${issueNumber} to "In Review"`);
              } catch (error) {
                console.error(`Failed to update issue #${issueNumber}: ${error.message}`);
              }
            }
