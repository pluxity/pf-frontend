# ì´ìŠˆ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê³  ì´ìŠˆì— ì—°ê²°í•©ë‹ˆë‹¤.
# ë¸Œëœì¹˜ ë„¤ì´ë°: {prefix}/issue-{number}
# prefixëŠ” ë¼ë²¨ì— ë”°ë¼ ê²°ì •: epic, bug -> fix, ê·¸ ì™¸ -> feature
name: Create Issue Branch

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Build branch name
        id: build
        env:
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels.*.name) }}
        run: |
          number=${{ github.event.issue.number }}

          # ë¼ë²¨ë¡œ prefix ê²°ì •
          if echo "$ISSUE_LABELS" | grep -qi "epic"; then
            prefix="epic"
          elif echo "$ISSUE_LABELS" | grep -qi "bug"; then
            prefix="fix"
          elif echo "$ISSUE_LABELS" | grep -qi "refactor"; then
            prefix="refactor"
          elif echo "$ISSUE_LABELS" | grep -qi "documentation"; then
            prefix="docs"
          elif echo "$ISSUE_LABELS" | grep -qi "test"; then
            prefix="test"
          else
            prefix="feature"
          fi

          branch="${prefix}/issue-${number}"

          echo "branch=${branch}" >> $GITHUB_OUTPUT
          echo "Built branch: ${branch}"

      - name: Create branch and push
        run: |
          BRANCH="${{ steps.build.outputs.branch }}"
          git checkout -b "$BRANCH"
          git push --set-upstream origin "$BRANCH"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on issue
        uses: actions/github-script@v6
        with:
          script: |
            const branch = process.env.BRANCH;
            const issue_number = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: `ğŸŒ¿ ë¸Œëœì¹˜ ìƒì„±ë¨: \`${branch}\`\n\n\`\`\`bash\ngit fetch origin\ngit checkout ${branch}\n\`\`\``
            });
        env:
          BRANCH: ${{ steps.build.outputs.branch }}
