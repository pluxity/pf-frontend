name: Close Issues and Update Project Status on Merge

on:
  pull_request:
    types: [closed]

jobs:
  # Feature → Epic 머지: Feature 이슈 Done 처리
  feature-to-epic:
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.base.ref, 'epic/')
    runs-on: ubuntu-latest
    steps:
      - name: Close linked issues and set Done status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Find linked issue numbers
            const pattern = /#(\d+)/g;
            const issueNumbers = new Set();

            let match;
            while ((match = pattern.exec(prBody)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }
            while ((match = pattern.exec(prTitle)) !== null) {
              issueNumbers.add(parseInt(match[1]));
            }

            if (issueNumbers.size === 0) {
              console.log('No linked issues found');
              return;
            }

            console.log(`Found linked issues: ${[...issueNumbers].join(', ')}`);

            // Project configuration
            const projectNumber = 17;
            const statusFieldId = 'PVTSSF_lADOC1m_S84BJx9Kzg5177k';
            const doneOptionId = '98236657';
            const projectId = 'PVT_kwDOC1m_S84BJx9K';

            for (const issueNumber of issueNumbers) {
              try {
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  state_reason: 'completed'
                });
                console.log(`Closed issue #${issueNumber}`);

                // Get issue's project item
                const issueResult = await github.graphql(`
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        id
                        projectItems(first: 10) {
                          nodes {
                            id
                            project { number }
                          }
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: issueNumber
                });

                const issue = issueResult.repository.issue;
                if (!issue) continue;

                const projectItem = issue.projectItems.nodes.find(
                  item => item.project.number === projectNumber
                );

                if (projectItem) {
                  // Update status to Done
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }) {
                        projectV2Item { id }
                      }
                    }
                  `, {
                    projectId: projectId,
                    itemId: projectItem.id,
                    fieldId: statusFieldId,
                    optionId: doneOptionId
                  });
                  console.log(`Set issue #${issueNumber} status to Done`);
                }
              } catch (error) {
                console.error(`Failed to process issue #${issueNumber}: ${error.message}`);
              }
            }

  # Epic → main 머지: Epic 이슈 + 모든 서브이슈 Done 처리
  epic-to-main:
    if: |
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      startsWith(github.event.pull_request.head.ref, 'epic/')
    runs-on: ubuntu-latest
    steps:
      - name: Close Epic and all sub-issues, set Done status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Find EPIC issue number from PR
            const pattern = /#(\d+)/g;
            const epicIssueNumbers = new Set();

            let match;
            while ((match = pattern.exec(prBody)) !== null) {
              epicIssueNumbers.add(parseInt(match[1]));
            }
            while ((match = pattern.exec(prTitle)) !== null) {
              epicIssueNumbers.add(parseInt(match[1]));
            }

            if (epicIssueNumbers.size === 0) {
              console.log('No EPIC issues found');
              return;
            }

            // Project configuration
            const projectNumber = 17;
            const statusFieldId = 'PVTSSF_lADOC1m_S84BJx9Kzg5177k';
            const doneOptionId = '98236657';
            const projectId = 'PVT_kwDOC1m_S84BJx9K';

            async function closeAndSetDone(issueNumber) {
              try {
                // Close the issue
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed',
                  state_reason: 'completed'
                });
                console.log(`Closed issue #${issueNumber}`);

                // Get issue's project item
                const issueResult = await github.graphql(`
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        id
                        projectItems(first: 10) {
                          nodes {
                            id
                            project { number }
                          }
                        }
                      }
                    }
                  }
                `, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: issueNumber
                });

                const issue = issueResult.repository.issue;
                if (!issue) return;

                const projectItem = issue.projectItems.nodes.find(
                  item => item.project.number === projectNumber
                );

                if (projectItem) {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }) {
                        projectV2Item { id }
                      }
                    }
                  `, {
                    projectId: projectId,
                    itemId: projectItem.id,
                    fieldId: statusFieldId,
                    optionId: doneOptionId
                  });
                  console.log(`Set issue #${issueNumber} status to Done`);
                }
              } catch (error) {
                console.error(`Failed to process issue #${issueNumber}: ${error.message}`);
              }
            }

            for (const epicNumber of epicIssueNumbers) {
              console.log(`Processing EPIC #${epicNumber}`);

              // Get sub-issues of this EPIC
              try {
                const subIssuesResponse = await github.request('GET /repos/{owner}/{repo}/issues/{issue_number}/sub_issues', {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: epicNumber
                });

                const subIssues = subIssuesResponse.data || [];
                console.log(`Found ${subIssues.length} sub-issues`);

                // Close and set Done for all sub-issues
                for (const subIssue of subIssues) {
                  await closeAndSetDone(subIssue.number);
                }
              } catch (error) {
                console.log(`Could not fetch sub-issues: ${error.message}`);
              }

              // Close and set Done for the EPIC itself
              await closeAndSetDone(epicNumber);
            }
